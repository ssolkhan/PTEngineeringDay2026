<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engineering Day — AI Word Cloud</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: linear-gradient(145deg, #020617 0%, #0c1425 50%, #0f172a 100%);
    font-family: 'DM Sans', sans-serif;
    color: #f1f5f9;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 36px 8px;
  }

  header h1 {
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  header .subtitle {
    color: #475569;
    font-size: 14px;
    margin-top: 4px;
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    color: #64748b;
    font-size: 14px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #fbbf24;
    display: inline-block;
  }

  .status-dot.live {
    background: #34d399;
    animation: pulse 2s infinite;
  }

  .status-dot.error { background: #f87171; }

  @keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:0.4 } }

  .clouds {
    flex: 1;
    display: flex;
    gap: 20px;
    padding: 12px 28px 16px;
    min-height: 0;
  }

  .cloud-panel {
    flex: 1;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 16px;
    overflow: hidden;
  }

  .cloud-panel.excites {
    background: linear-gradient(180deg, rgba(52,211,153,0.06) 0%, rgba(52,211,153,0.02) 100%);
    border: 1px solid rgba(52,211,153,0.15);
  }

  .cloud-panel.concerns {
    background: linear-gradient(180deg, rgba(249,115,22,0.06) 0%, rgba(249,115,22,0.02) 100%);
    border: 1px solid rgba(249,115,22,0.15);
  }

  .cloud-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .cloud-title .icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .excites .icon { background: rgba(52,211,153,0.15); }
  .concerns .icon { background: rgba(249,115,22,0.15); }

  .cloud-title h2 {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 0.02em;
  }

  .excites h2 { color: #34d399; }
  .concerns h2 { color: #f97316; }

  .cloud-canvas-wrap {
    flex: 1;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .waiting {
    color: #334155;
    font-size: 16px;
    font-style: italic;
  }

  footer {
    padding: 0 36px 16px;
    text-align: center;
    color: #1e293b;
    font-size: 12px;
  }

  .update-time { color: #334155; font-size: 12px; }
</style>
</head>
<body>

<header>
  <div>
    <h1>What Does AI Mean to You?</h1>
    <div class="subtitle">Engineering Day — Live Responses</div>
  </div>
  <div class="status-bar">
    <div style="display:flex;align-items:center;gap:6px">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Loading...</span>
    </div>
    <span class="update-time" id="updateTime"></span>
  </div>
</header>

<div class="clouds">
  <div class="cloud-panel excites">
    <div class="cloud-title">
      <span class="icon">✦</span>
      <h2>What Excites Us</h2>
    </div>
    <div class="cloud-canvas-wrap">
      <canvas id="excitesCanvas"></canvas>
      <div class="waiting" id="excitesWaiting">Waiting for responses...</div>
    </div>
  </div>
  <div class="cloud-panel concerns">
    <div class="cloud-title">
      <span class="icon">⚡</span>
      <h2>What Concerns Us</h2>
    </div>
    <div class="cloud-canvas-wrap">
      <canvas id="concernsCanvas"></canvas>
      <div class="waiting" id="concernsWaiting">Waiting for responses...</div>
    </div>
  </div>
</div>

<footer>Scan the QR code at check-in to add your voice · Refreshes every 5 seconds</footer>

<script>
// ─── Hardcoded Config ───
const SHEET_ID = "1tPsgI_H442gUM88_ly2VROAw2Tq1SIGapJG1N9UQZYE";
const SHEET_GID = "1638596277";
const POLL_MS = 5000;

// ─── Stop words ───
const STOP = new Set([
  "the","a","an","and","or","but","in","on","at","to","for","of","with",
  "by","is","it","that","this","are","was","be","as","its","i","my","me",
  "we","our","us","can","will","about","how","what","so","not","no",
  "very","too","just","more","also","like","from","into","has","have",
  "do","does","am","been","being","they","them","their","there","could",
  "would","should","may","might","all","some","many","much","really",
  "think","things","thing","lot","lots","way","make","get","know"
]);

// ─── Google Visualization API (returns fresh data every request) ───
function buildGvizUrl() {
  return "https://docs.google.com/spreadsheets/d/" + SHEET_ID +
    "/gviz/tq?tqx=out:csv&gid=" + SHEET_GID;
}

// ─── CSV Parsing ───
function parseCSVRow(line) {
  const r = []; let cur = "", inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (inQ) {
      if (c === '"' && line[i+1] === '"') { cur += '"'; i++; }
      else if (c === '"') inQ = false;
      else cur += c;
    } else {
      if (c === '"') inQ = true;
      else if (c === ',') { r.push(cur); cur = ""; }
      else cur += c;
    }
  }
  r.push(cur);
  return r;
}

function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return { excites: [], concerns: [] };
  const excites = [], concerns = [];
  for (let i = 1; i < lines.length; i++) {
    const row = parseCSVRow(lines[i]);
    if (row.length >= 3) {
      if (row[1].trim()) excites.push(row[1].trim());
      if (row[2].trim()) concerns.push(row[2].trim());
    }
  }
  return { excites, concerns };
}

function extractWords(phrases) {
  const counts = {};
  phrases.forEach(p => {
    p.toLowerCase().replace(/[^a-zA-Z0-9\s'-]/g, " ").split(/[\s,;/]+/)
      .filter(w => w.length > 1 && !STOP.has(w))
      .forEach(w => { counts[w] = (counts[w] || 0) + 1; });
  });
  return Object.entries(counts)
    .map(([text, count]) => ({ text, count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 50);
}

// ─── State ───
let currentData = { excites: [], concerns: [] };

async function fetchAndRender() {
  const dot = document.getElementById("statusDot");
  const txt = document.getElementById("statusText");
  const time = document.getElementById("updateTime");
  try {
    const res = await fetch(buildGvizUrl());
    if (!res.ok) throw new Error("HTTP " + res.status);
    const csv = await res.text();
    currentData = parseCSV(csv);
    const count = Math.max(currentData.excites.length, currentData.concerns.length);
    dot.className = "status-dot live";
    txt.textContent = "Live \u00b7 " + count + " response" + (count !== 1 ? "s" : "");
    time.textContent = "Updated " + new Date().toLocaleTimeString();
    renderClouds();
  } catch (e) {
    console.error("Fetch error:", e);
    dot.className = "status-dot error";
    txt.textContent = "Error \u2014 check Sheet sharing settings & retry";
  }
}

// ─── Word Cloud Renderer ───
const GREEN = ["#34d399","#6ee7b7","#a7f3d0","#10b981","#059669","#22d3ee","#2dd4bf","#5eead4"];
const ORANGE = ["#f97316","#fb923c","#fdba74","#ef4444","#f59e0b","#e11d48","#dc2626","#fbbf24"];

function renderCloud(canvasId, waitingId, words, colors) {
  const canvas = document.getElementById(canvasId);
  const waiting = document.getElementById(waitingId);
  const parent = canvas.parentElement;
  const w = parent.clientWidth - 8;
  const h = parent.clientHeight - 8;

  if (words.length === 0) {
    canvas.style.display = "none";
    waiting.style.display = "block";
    return;
  }
  canvas.style.display = "block";
  waiting.style.display = "none";

  const dpr = window.devicePixelRatio || 1;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + "px";
  canvas.style.height = h + "px";

  const ctx = canvas.getContext("2d");
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  const maxC = Math.max(...words.map(x => x.count));
  const minC = Math.min(...words.map(x => x.count));
  const placed = [];

  words.forEach((word, i) => {
    const norm = maxC === minC ? 0.5 : (word.count - minC) / (maxC - minC);
    const fontSize = Math.max(15, Math.floor(17 + norm * 54));
    const color = colors[i % colors.length];

    ctx.font = "800 " + fontSize + "px 'DM Sans', sans-serif";
    const met = ctx.measureText(word.text);
    const tw = met.width + 10;
    const th = fontSize + 8;

    let found = false, bx = 0, by = 0;
    for (let r = 0; r < Math.max(w, h) * 0.55 && !found; r += 3) {
      for (let a = 0; a < Math.PI * 2 && !found; a += 0.25 + Math.random() * 0.15) {
        const x = w/2 + r * Math.cos(a + i * 0.5) - tw/2;
        const y = h/2 + r * Math.sin(a + i * 0.5) + th/4;
        if (x < 4 || x + tw > w - 4 || y - th < 4 || y > h - 4) continue;
        const overlaps = placed.some(p =>
          x < p.x + p.w + 5 && x + tw + 5 > p.x &&
          y - th < p.y + 5 && y + 5 > p.y - p.h
        );
        if (!overlaps) { bx = x; by = y; found = true; }
      }
    }

    if (found) {
      placed.push({ x: bx, y: by, w: tw, h: th });
      ctx.globalAlpha = 0.85 + norm * 0.15;
      ctx.fillStyle = color;
      ctx.font = "800 " + fontSize + "px 'DM Sans', sans-serif";
      ctx.fillText(word.text, bx + 5, by);
      ctx.globalAlpha = 1;
    }
  });
}

function renderClouds() {
  renderCloud("excitesCanvas", "excitesWaiting", extractWords(currentData.excites), GREEN);
  renderCloud("concernsCanvas", "concernsWaiting", extractWords(currentData.concerns), ORANGE);
}

// ─── Auto-start ───
fetchAndRender();
setInterval(fetchAndRender, POLL_MS);
window.addEventListener("resize", renderClouds);
</script>
</body>
</html>
